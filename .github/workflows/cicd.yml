name: Deploy to GCP VM
on:
  push:
    branches:
      - main
jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Authenticate to Google Cloud
        run: |
          echo '${{ secrets.SERVICE_ACCOUNT_KEY }}' > gcp-key.json
          gcloud auth activate-service-account --key-file=gcp-key.json
          rm gcp-key.json
      
      - name: Set up gcloud CLI
        uses: google-github-actions/setup-gcloud@v2
      
      - name: Configure gcloud and verify authentication
        run: |
          gcloud config set project ${{ secrets.GCP_PROJECT_ID }}
          
          echo "=== All authenticated accounts ==="
          gcloud auth list
          
          echo "=== Active accounts only ==="
          gcloud auth list --filter=status:ACTIVE --format="value(account)"
          
          # Set the active account explicitly
          ACTIVE_ACCOUNT=$(gcloud auth list --filter=status:ACTIVE --format="value(account)" | head -1)
          if [ ! -z "$ACTIVE_ACCOUNT" ]; then
            gcloud config set account $ACTIVE_ACCOUNT
            echo "Set active account: $ACTIVE_ACCOUNT"
            
            echo "=== Final gcloud config ==="
            gcloud config list
          else
            echo "‚ùå No active account found"
            echo "All accounts:"
            gcloud auth list
            exit 1
          fi
      
      - name: Copy files to GCP VM
        run: |
          # Create archive with warning suppression and better exclusions
          tar czf code.tar.gz \
            --exclude='.git' \
            --exclude='node_modules' \
            --exclude='.github' \
            --exclude='gha-creds-*.json' \
            --warning=no-file-changed \
            .
          
          # Debug: Check what we have
          echo "=== Files created ==="
          ls -la code.tar.gz
          
          echo "=== VM Status ==="
          gcloud compute instances describe ubuntu-4gb --zone=us-central1-c --format="value(status)"
          
          # Try SCP with verbose output
          echo "=== Attempting SCP ==="
          gcloud compute scp code.tar.gz tanmaymi251@ubuntu-4gb:~ --zone=us-central1-c --verbosity=debug
          
          echo "=== Attempting SSH ==="
          gcloud compute ssh tanmaymi251@ubuntu-4gb --zone=us-central1-c --command="mkdir -p ~/test && mv ~/code.tar.gz ~/test/ && cd ~/test && tar xzf code.tar.gz && rm code.tar.gz" --verbosity=debug
