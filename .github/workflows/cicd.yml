name: Deploy to GCP VM
on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: '${{ secrets.SERVICE_ACCOUNT_KEY }}'
      
      - name: Set up gcloud CLI
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: '${{ secrets.GCP_PROJECT_ID }}'
      
      - name: Verify authentication
        run: |
          echo "=== Current gcloud config ==="
          gcloud config list
          echo "=== Testing authentication ==="
          gcloud compute instances list --limit=1
      
      - name: Prepare and copy files to GCP VM
        run: |
          # Create a clean directory for deployment
          mkdir -p deploy-temp
          
          # Copy only necessary files (exclude common unwanted files)
          rsync -av --progress . deploy-temp/ \
            --exclude='.git' \
            --exclude='node_modules' \
            --exclude='.env*' \
            --exclude='*.log' \
            --exclude='.DS_Store' \
            --exclude='coverage' \
            --exclude='dist' \
            --exclude='build'
          
          # Create archive from clean directory
          cd deploy-temp
          tar czf ../code.tar.gz .
          cd ..
          
          # Ensure target directory exists on VM
          gcloud compute ssh tanmaymi251@ubuntu-4gb \
            --zone=us-central1-c \
            --ssh-key-expire-after=1h \
            --command="mkdir -p ~/test"
          
          # Copy archive to VM
          gcloud compute scp code.tar.gz tanmaymi251@ubuntu-4gb:~/test/ \
            --zone=us-central1-c \
            --ssh-key-expire-after=1h
          
          # Extract on VM and clean up
          gcloud compute ssh tanmaymi251@ubuntu-4gb \
            --zone=us-central1-c \
            --ssh-key-expire-after=1h \
            --command="cd ~/test && tar xzf code.tar.gz && rm code.tar.gz"
          
          # Clean up local files
          rm -rf deploy-temp code.tar.gz
